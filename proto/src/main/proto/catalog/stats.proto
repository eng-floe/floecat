syntax = "proto3";
package ai.floedb.metacat.catalog;

option java_multiple_files = true;
option java_package = "ai.floedb.metacat.catalog.rpc";

import "common/common.proto";
import "catalog/table.proto";

import "google/protobuf/timestamp.proto";

message UpstreamStamp {
  TableFormat system = 1;
  string table_native_id = 2;
  string commit_ref = 3;
  google.protobuf.Timestamp fetched_at = 4;
  map<string,string> properties = 99;
}

message Ndv {
  oneof mode {
    int64 exact = 1;
    NdvApprox approx = 2;
  }

  repeated NdvSketch sketches = 20;
}

message NdvApprox {
  double estimate = 1;
  double relative_standard_error = 2;
  double confidence_lower = 3;
  double confidence_upper = 4;
  double confidence_level = 5;
  uint64 rows_seen = 10;
  uint64 rows_total = 11;
  string method = 20;
  map<string,string> properties = 99;
}

message NdvSketch {
  string type = 1;
  bytes data = 2;
  string encoding = 3;
  string compression = 4;
  uint32 version = 5;
  map<string,string> properties = 99;
}

// ---------- Table-level stats ----------

message TableStats {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  UpstreamStamp upstream = 3;
  int64 row_count = 10;
  int64 data_file_count = 11;
  int64 total_size_bytes = 12;
  Ndv ndv = 20;
  map<string, string> properties = 99;
}

// ---------- Column-level stats  ----------

message ColumnStats {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  string column_id = 3;
  string column_name = 4;
  string logical_type = 5;
  UpstreamStamp upstream = 6;
  int64 value_count = 9;
  int64 null_count = 10;
  int64 nan_count = 11;
  Ndv ndv = 12;
  string min = 20;
  string max = 21;
  bytes histogram = 30;
  bytes tdigest = 31;
  map<string, string> properties = 99;
}

// ---------- File-level stats ------------

message FileColumnStats {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  string file_path = 3;
  int64 row_count = 4;
  int64 size_bytes = 5;
  repeated ColumnStats columns = 6;
}

// ---------- Requests/Responses ----------

message PutTableStatsRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  TableStats stats = 3;
  ai.floedb.metacat.common.IdempotencyKey idempotency = 4;
}
message PutTableStatsResponse {
  TableStats stats = 1;
  ai.floedb.metacat.common.MutationMeta meta = 2;
}

message PutColumnStatsBatchRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  repeated ColumnStats columns = 3;
  ai.floedb.metacat.common.IdempotencyKey idempotency = 4;
}
message PutColumnStatsBatchResponse {
  int32 upserted = 1;
}

message PutFileColumnStatsBatchRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  repeated FileColumnStats files = 3;
  ai.floedb.metacat.common.IdempotencyKey idempotency = 4;
}
message PutFileColumnStatsBatchResponse {
  int32 upserted = 1;
}

message GetTableStatsRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  ai.floedb.metacat.common.SnapshotRef snapshot = 2;
  ai.floedb.metacat.common.PageRequest page = 3;
}
message GetTableStatsResponse {
  TableStats stats = 1;
  ai.floedb.metacat.common.PageResponse page = 2;
}

message ListColumnStatsRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  ai.floedb.metacat.common.SnapshotRef snapshot = 2;
  ai.floedb.metacat.common.PageRequest page = 3;
}
message ListColumnStatsResponse {
  repeated ColumnStats columns = 1;
  ai.floedb.metacat.common.PageResponse page = 2;
}

message ListFileColumnStatsRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  ai.floedb.metacat.common.SnapshotRef snapshot = 2;
  ai.floedb.metacat.common.PageRequest page = 3;
}
message ListFileColumnStatsResponse {
  repeated FileColumnStats file_columns = 1;
  ai.floedb.metacat.common.PageResponse page = 2;
}

// ---------- Services ----------

service TableStatisticsService {
  rpc GetTableStats(GetTableStatsRequest) returns (GetTableStatsResponse);
  rpc ListColumnStats(ListColumnStatsRequest) returns (ListColumnStatsResponse);
  rpc ListFileColumnStats(ListFileColumnStatsRequest) returns (ListFileColumnStatsResponse);
  rpc PutTableStats(PutTableStatsRequest) returns (PutTableStatsResponse);
  rpc PutColumnStatsBatch(PutColumnStatsBatchRequest) returns (PutColumnStatsBatchResponse);
  rpc PutFileColumnStatsBatch(PutFileColumnStatsBatchRequest) returns (PutFileColumnStatsBatchResponse);
}