syntax = "proto3";

package ai.floedb.metacat.query;

option java_multiple_files = true;
option java_package = "ai.floedb.metacat.query.rpc";
option java_outer_classname = "QueryLifecycleProto";

import "common/common.proto";
import "google/protobuf/timestamp.proto";

/**
 * QUERY LIFECYCLE SERVICE
 * ------------------------
 * Goal: Provide O(1) query creation and TTL management.
 *
 * This service manages ONLY:
 *   - Input references (tables/views)
 *   - Snapshot pinning
 *   - View expansion
 *   - Row/column obligations
 *   - Query lifecycle (creation, renewal, completion)
 *
 * This service explicitly does NOT:
 *   - resolve schemas (temporary exception)
 *   - plan scans
 *   - perform pruning
 *   - fetch physical metadata
 *
 * All metadata work must move to:
 *   - QuerySchemaService
 *   - QueryScanService
 */

message QueryInput {
  // A referenced table or view.
  oneof target {
    ai.floedb.metacat.common.NameRef name = 1;
    ai.floedb.metacat.common.ResourceId table_id = 2;
    ai.floedb.metacat.common.ResourceId view_id = 3;
  }

  // Optional: per-input snapshot override.
  ai.floedb.metacat.common.SnapshotRef snapshot = 10;
}

enum QueryStatus {
  SUBMITTED = 0;
  COMPLETED = 1;
  FAILED = 2;
}

/**
 * A single pinned snapshot resulting from BeginQuery().
 */
message SnapshotPin {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  // If snapshot_id==0, pin uses this "as of" timestamp.
  google.protobuf.Timestamp as_of = 3;
}

/**
 * All pinned snapshots for a query.
 */
message SnapshotSet {
  repeated SnapshotPin pins = 1;
}

/**
 * Derived view expansion information.
 */
message ExpansionMap {
  message ExpandedView {
    ai.floedb.metacat.common.ResourceId view_id = 1;
    string canonical_sql = 2;
    repeated ai.floedb.metacat.common.ResourceId base_table_ids = 3;
  }

  repeated ExpandedView views = 1;

  // Tables actually read but referenced via a view.
  repeated ai.floedb.metacat.common.ResourceId read_via_view_tables = 2;
}

/**
 * Governance obligations applied to tables.
 */
message TableObligations {
  ai.floedb.metacat.common.ResourceId table_id = 1;

  message ColumnMask {
    string column = 1;          // logical column name
    string expression = 2;      // SQL replacement
  }

  repeated ColumnMask masks = 2;

  // Optional SQL expression restricting returned rows.
  string row_filter_expression = 3;
}

/**
 * Summary describing the lifecycle state and pinned metadata of a query.
 *
 * NOTE:
 *   This intentionally excludes schemas and scan bundles.
 *   These belong in dedicated services for performance and clarity.
 */
message QueryDescriptor {
  string query_id = 1;
  string tenant_id = 2;

  QueryStatus query_status = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp expires_at = 5;

  SnapshotSet snapshots = 6;
  ExpansionMap expansion = 7;
  repeated TableObligations obligations = 8;
}

/** BeginQuery: creates a new query context. */
message BeginQueryRequest {
  // TTL for the query context (in seconds).
  int32 ttl_seconds = 1;

  // Optional timestamp used by downstream RPCs when no snapshot override is provided.
  google.protobuf.Timestamp as_of_default = 2;
}

/**
 * Response contains:
 *   QueryDescriptor (always)
 */
message BeginQueryResponse {
  QueryDescriptor query = 1;
}

message RenewQueryRequest {
  string query_id = 1;
  int32 ttl_seconds = 2;
}

message RenewQueryResponse {
  string query_id = 1;
  google.protobuf.Timestamp expires_at = 2;
}

message EndQueryRequest {
  string query_id = 1;
  bool commit = 2;
}

message EndQueryResponse {
  string query_id = 1;
}

message GetQueryRequest {
  string query_id = 1;
}

message GetQueryResponse {
  QueryDescriptor query = 1;
}

service QueryService {
  rpc BeginQuery(BeginQueryRequest) returns (BeginQueryResponse);
  rpc RenewQuery(RenewQueryRequest) returns (RenewQueryResponse);
  rpc EndQuery(EndQueryRequest) returns (EndQueryResponse);
  rpc GetQuery(GetQueryRequest) returns (GetQueryResponse);
}