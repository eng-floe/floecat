syntax = "proto3";

package ai.floedb.metacat.catalog;
option java_multiple_files = true;
option java_package = "ai.floedb.metacat.catalog.rpc";

import "common/common.proto";
import "catalog/catalog.proto";

import "google/protobuf/timestamp.proto";

// ---------- Common mutation helpers ----------

message IdempotencyKey {
  string key = 1;
}

message Precondition {
  int64 expected_version = 1;
  string expected_etag = 2;
}

message MutationMeta {
  string pointer_key = 1;
  string blob_uri = 2;
  int64 pointer_version = 3;
  string etag = 4;
  google.protobuf.Timestamp updated_at = 5;
}

// ---------- Catalog ----------

message CatalogSpec {
  string display_name = 1;
  string description = 2;
  string connector_ref = 3;
  map<string,string> options = 4;
  string policy_ref = 5;
}

message CreateCatalogRequest {
  CatalogSpec spec = 1;
  IdempotencyKey idempotency = 2;
}
message CreateCatalogResponse {
  Catalog catalog = 1;
  MutationMeta meta = 2;
}

message UpdateCatalogRequest {
  ai.floedb.metacat.common.ResourceId catalog_id = 1;
  CatalogSpec spec = 2;
  Precondition precondition = 3;
}
message UpdateCatalogResponse {
  Catalog catalog = 1;
  MutationMeta meta = 2;
}

message DeleteCatalogRequest {
  ai.floedb.metacat.common.ResourceId catalog_id = 1;
  bool require_empty = 2;
  Precondition precondition = 3;
}
message DeleteCatalogResponse {
  MutationMeta meta = 1;
}

// ---------- Namespace ----------

message NamespaceSpec {
  ai.floedb.metacat.common.ResourceId catalog_id = 1;
  string display_name = 2;
  string description = 3;
  repeated string path = 4;
  map<string,string> annotations = 5;
  string policy_ref = 6;
}

message CreateNamespaceRequest {
  NamespaceSpec spec = 1;
  IdempotencyKey idempotency = 2;
}
message CreateNamespaceResponse {
  Namespace namespace = 1;
  MutationMeta meta = 2;
}

message RenameNamespaceRequest {
  ai.floedb.metacat.common.ResourceId namespace_id = 1;
  string new_display_name = 2;
  repeated string new_path = 3;
  ai.floedb.metacat.common.ResourceId new_catalog_id = 4;
  Precondition precondition = 5;
}
message RenameNamespaceResponse {
  Namespace namespace = 1;
  MutationMeta meta = 2;
}

message DeleteNamespaceRequest {
  ai.floedb.metacat.common.ResourceId namespace_id = 1;
  bool require_empty = 2;
  Precondition precondition = 3;
}
message DeleteNamespaceResponse {
  MutationMeta meta = 1;
}

// ---------- Table ----------

message TableSpec {
  ai.floedb.metacat.common.ResourceId catalog_id = 1;
  ai.floedb.metacat.common.ResourceId namespace_id = 2;
  string display_name = 3;
  string description = 4;
  string root_uri = 5;
  string schema_json = 6;
  repeated string partition_keys = 7;
  string format = 8;
  map<string,string> properties = 9;
  string policy_ref = 10;
}

message CreateTableRequest {
  TableSpec spec = 1;
  IdempotencyKey idempotency = 2;
}
message CreateTableResponse {
  Table table = 1;
  MutationMeta meta = 2;
}

message UpdateTableSchemaRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  string schema_json = 2;
  repeated string partition_keys = 3;
  map<string,string> properties = 4;
  Precondition precondition = 5;
}
message UpdateTableSchemaResponse {
  Table table = 1;
  MutationMeta meta = 2;
}

message RenameTableRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  string new_display_name = 2;
  Precondition precondition = 3;
}
message RenameTableResponse {
  Table table = 1;
  MutationMeta meta = 2;
}

message MoveTableRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  string new_display_name = 2;

  ai.floedb.metacat.common.ResourceId new_namespace_id = 3;

  Precondition precondition = 5;
}
message MoveTableResponse {
  Table table = 1;
  MutationMeta meta = 2;
}

message DeleteTableRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  bool purge_stats = 2;
  bool purge_snapshots = 3;
  Precondition precondition = 4;
}
message DeleteTableResponse {
  MutationMeta meta = 1;
}

// ---------- Snapshot ----------

message SnapshotSpec {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  google.protobuf.Timestamp upstream_created_at = 3;
  google.protobuf.Timestamp ingested_at = 4;
  int64 parent_snapshot_id = 5;
}

message CreateSnapshotRequest {
  SnapshotSpec spec = 1;
  IdempotencyKey idempotency = 2;
}
message CreateSnapshotResponse {
  Snapshot snapshot = 1;
  MutationMeta meta = 2;
}

message DeleteSnapshotRequest {
  ai.floedb.metacat.common.ResourceId table_id = 1;
  int64 snapshot_id = 2;
  Precondition precondition = 3;
}
message DeleteSnapshotResponse {
  MutationMeta meta = 1;
}

// ---------- Service ----------

service ResourceMutation {
  rpc CreateCatalog(CreateCatalogRequest) returns (CreateCatalogResponse);
  rpc UpdateCatalog(UpdateCatalogRequest) returns (UpdateCatalogResponse);
  rpc DeleteCatalog(DeleteCatalogRequest) returns (DeleteCatalogResponse);

  rpc CreateNamespace(CreateNamespaceRequest) returns (CreateNamespaceResponse);
  rpc RenameNamespace(RenameNamespaceRequest) returns (RenameNamespaceResponse);
  rpc DeleteNamespace(DeleteNamespaceRequest) returns (DeleteNamespaceResponse);

  rpc CreateTable(CreateTableRequest) returns (CreateTableResponse);
  rpc UpdateTableSchema(UpdateTableSchemaRequest) returns (UpdateTableSchemaResponse);
  rpc RenameTable(RenameTableRequest) returns (RenameTableResponse);
  rpc MoveTable(MoveTableRequest) returns (MoveTableResponse);
  rpc DeleteTable(DeleteTableRequest) returns (DeleteTableResponse);
  rpc CreateSnapshot(CreateSnapshotRequest) returns (CreateSnapshotResponse);
  rpc DeleteSnapshot(DeleteSnapshotRequest) returns (DeleteSnapshotResponse);
}
